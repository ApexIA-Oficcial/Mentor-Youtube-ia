<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ApexiA Mentor Pro | Growth</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        :root { --primary: #ff0000; --dark: #0f0f0f; --text: #ffffff; --bubble: #1e1e1e; }
        body, html { margin: 0; padding: 0; font-family: 'Inter', sans-serif; background: var(--dark); color: var(--text); height: 100vh; overflow: hidden; }
        #landing-page { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; text-align: center; background: radial-gradient(circle, #330000, #0f0f0f); }
        .logo { font-size: 3.5rem; font-weight: 900; letter-spacing: -2px; text-transform: uppercase; margin-bottom: 20px; }
        .logo span { color: var(--primary); }
        .btn-google { background: white; color: black; padding: 15px 35px; border-radius: 40px; border: none; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 12px; }
        #app-container { display: none; flex-direction: column; height: 100vh; max-width: 900px; margin: 0 auto; width: 100%; background: var(--dark); border-left: 1px solid #333; border-right: 1px solid #333; }
        header { padding: 15px 25px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; background: #0f0f0f; }
        #chat-window { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .msg { max-width: 85%; padding: 14px 20px; border-radius: 18px; line-height: 1.5; font-size: 1rem; }
        .ai { align-self: flex-start; background: var(--bubble); white-space: pre-wrap; }
        .user { align-self: flex-end; background: var(--primary); }
        .data-chip { background: rgba(0, 255, 0, 0.1); color: #00ff00; padding: 12px; border-radius: 10px; font-size: 0.85rem; border: 1px solid rgba(0, 255, 0, 0.2); margin-bottom: 10px; }
        .input-box { padding: 20px; background: #1a1a1a; display: flex; gap: 10px; border-top: 1px solid #333; }
        input { flex: 1; background: #2a2a2a; border: 1px solid #444; padding: 12px 20px; border-radius: 30px; color: white; outline: none; }
        button { background: var(--primary); color: white; border: none; padding: 10px 25px; border-radius: 30px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

    <!-- LANDING -->
    <div id="landing-page">
        <div class="logo">APEX<span>IA</span></div>
        <p style="color: #aaa; margin-bottom: 30px;">AnÃ¡lise inteligente para criadores de elite.</p>
        <button class="btn-google" onclick="iniciarLogin()">
            <img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg" width="20">
            Conectar Canal ApexiA
        </button>
    </div>

    <!-- APP -->
    <div id="app-container">
        <header>
            <div style="font-weight: 900; font-size: 1.3rem;">APEX<span>IA</span> PRO</div>
            <div style="display: flex; align-items: center; gap: 15px;">
                <div id="model-tag" style="font-size: 0.6rem; color: #888;">MOTOR: CARREGANDO...</div>
                <button onclick="logout()" style="background:#333; border:none; color:white; padding: 5px 12px; border-radius:15px; cursor:pointer; font-size:0.7rem;">Sair</button>
            </div>
        </header>
        <div id="chat-window">
            <div id="stats-area"></div>
            <div class="msg ai">OlÃ¡! Sou o Mentor ApexiA. Estou preparando seu relatÃ³rio...</div>
        </div>
        <div class="input-box">
            <input type="text" id="user-input" placeholder="Mande sua dÃºvida estratÃ©gica...">
            <button onclick="askGemini()">Analisar</button>
        </div>
    </div>

    <script>
        const CLIENT_ID = "145100322345-70nlh619s577puk5c75u19trip13nkme.apps.googleusercontent.com";
        const GEMINI_KEY = "AIzaSyBx1QhaQV97RdhIsPMutXXN9UGhNAbfyNk"; // <-- COLOQUE SUA CHAVE NOVA DO AI STUDIO
        
        let accessToken = localStorage.getItem('apexia_token');
        let tokenClient;
        let modeloEncontrado = "models/gemini-1.5-flash";
        let contextoCanalGlobal = "Dados bÃ¡sicos carregados.";

        window.onload = function() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                // ESCOPOS ADICIONADOS PARA ANALYTICS
                scope: 'https://www.googleapis.com/auth/youtube.readonly https://www.googleapis.com/auth/yt-analytics.readonly',
                callback: (tokenResponse) => { 
                    if (tokenResponse.access_token) {
                        accessToken = tokenResponse.access_token;
                        localStorage.setItem('apexia_token', accessToken);
                        entrarNoApp();
                    }
                },
            });
            if (accessToken) entrarNoApp();
        };

        function iniciarLogin() { tokenClient.requestAccessToken(); }

        function logout() {
            localStorage.removeItem('apexia_token');
            location.reload();
        }

        async function entrarNoApp() {
            document.getElementById('landing-page').style.display = 'none';
            document.getElementById('app-container').style.display = 'flex';
            await configurarIA();
            await puxarDadosCanal();
        }

        async function configurarIA() {
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${GEMINI_KEY}`);
                const data = await res.json();
                const pref = data.models.find(m => m.name.includes("1.5-flash")) || data.models[0];
                modeloEncontrado = pref.name;
                document.getElementById('model-tag').innerText = "MOTOR: " + modeloEncontrado.split('/')[1].toUpperCase();
            } catch (e) { console.error("Erro IA"); }
        }

        async function puxarDadosCanal() {
            let nomeCanal = "Criador";
            let inscritos = "0";

            // 1. Tentar dados bÃ¡sicos (Sempre funciona se logado)
            try {
                const resB = await fetch('https://www.googleapis.com/youtube/v3/channels?part=snippet,statistics&mine=true', {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                const dataB = await resB.json();
                const canal = dataB.items[0];
                nomeCanal = canal.snippet.title;
                inscritos = canal.statistics.subscriberCount;
                
                document.getElementById('stats-area').innerHTML = `
                    <div class="data-chip">ðŸ“Š Canal: <b>${nomeCanal}</b> | Inscritos: <b>${Number(inscritos).toLocaleString()}</b></div>
                `;
            } catch (e) { console.error("Erro canais"); }

            // 2. Tentar Analytics (Pode falhar se a API nÃ£o estiver ativa no Cloud)
            try {
                const hoje = new Date().toISOString().split('T')[0];
                const trintaDias = new Date(new Date().setDate(new Date().getDate() - 30)).toISOString().split('T')[0];
                
                const resA = await fetch(`https://youtubeanalytics.googleapis.com/v1/reports?ids=channel==MINE&startDate=${trintaDias}&endDate=${hoje}&metrics=views,estimatedMinutesWatched,averageViewDuration&dimensions=day`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                const analytics = await resA.json();
                
                let viewsTotais = 0;
                if(analytics.rows) analytics.rows.forEach(r => viewsTotais += r[1]);

                contextoCanalGlobal = `Canal: ${nomeCanal}. Inscritos: ${inscritos}. Views Ãºltimos 30 dias: ${viewsTotais}.`;
                
                if(analytics.rows) {
                    document.getElementById('stats-area').innerHTML += `
                        <div class="data-chip" style="background:rgba(0,150,255,0.1); color:#00aaff; border-color:#00aaff44;">ðŸ“ˆ Views (30d): <b>${viewsTotais.toLocaleString()}</b></div>
                    `;
                }
                addMsg('ai', `Tudo pronto, criador do canal **${nomeCanal}**! JÃ¡ puxei seus dados de performance. Como vamos crescer hoje?`);
            } catch (e) {
                addMsg('ai', `Conectado como **${nomeCanal}**! Mas o Analytics ainda estÃ¡ desativado no seu Google Cloud. Ative a 'YouTube Analytics API' para mentorias mais profundas.`);
            }
        }

        async function askGemini() {
            const input = document.getElementById('user-input');
            const texto = input.value.trim();
            if (!texto) return;

            addMsg('user', texto);
            input.value = '';

            const prompt = `VocÃª Ã© o Mentor ApexiA. Contexto: ${contextoCanalGlobal}. Pergunta: ${texto}`;

            try {
                const url = `https://generativelanguage.googleapis.com/v1beta/${modeloEncontrado}:generateContent?key=${GEMINI_KEY}`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await response.json();
                addMsg('ai', data.candidates[0].content.parts[0].text);
            } catch (e) { addMsg('ai', "Erro na IA. Verifique sua conexÃ£o e VPN."); }
        }

        function addMsg(role, content) {
            const chat = document.getElementById('chat-window');
            const div = document.createElement('div');
            div.className = `msg ${role}`;
            div.innerText = content;
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
        }
    </script>
</body>
</html>
