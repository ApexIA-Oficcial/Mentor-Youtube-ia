<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ApexiA Mentor Pro | Oficial</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
        :root { --primary: #ff0000; --dark: #0f0f0f; --text: #ffffff; --bubble: #1e1e1e; }
        body, html { margin: 0; padding: 0; font-family: 'Inter', sans-serif; background: var(--dark); color: var(--text); height: 100vh; overflow: hidden; }
        #landing-page { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; text-align: center; background: radial-gradient(circle, #330000, #0f0f0f); }
        .logo { font-size: 3.5rem; font-weight: 900; letter-spacing: -2px; text-transform: uppercase; margin-bottom: 20px; }
        .logo span { color: var(--primary); }
        .btn-google { background: white; color: black; padding: 15px 35px; border-radius: 40px; border: none; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 12px; }
        #app-container { display: none; flex-direction: column; height: 100vh; max-width: 900px; margin: 0 auto; background: var(--dark); border-left: 1px solid #333; border-right: 1px solid #333; }
        header { padding: 15px 25px; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        #chat-window { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .msg { max-width: 85%; padding: 14px 20px; border-radius: 18px; line-height: 1.5; font-size: 1rem; }
        .ai { align-self: flex-start; background: var(--bubble); white-space: pre-wrap; }
        .user { align-self: flex-end; background: var(--primary); }
        .data-chip { background: rgba(0, 255, 0, 0.1); color: #00ff00; padding: 12px; border-radius: 10px; font-size: 0.85rem; border: 1px solid rgba(0, 255, 0, 0.2); margin-bottom: 10px; }
        .input-box { padding: 20px; background: #1a1a1a; display: flex; gap: 10px; border-top: 1px solid #333; }
        input { flex: 1; background: #2a2a2a; border: 1px solid #444; padding: 12px 20px; border-radius: 30px; color: white; outline: none; }
        button { background: var(--primary); color: white; border: none; padding: 10px 25px; border-radius: 30px; font-weight: bold; cursor: pointer; }
    </style>
</head>
<body>

    <div id="landing-page">
        <div class="logo">APEX<span>IA</span></div>
        <p style="color: #aaa; margin-bottom: 30px;">A IA que analisa seu canal e cria sua estrat√©gia.</p>
        <button class="btn-google" onclick="iniciarLogin()">
            <img src="https://upload.wikimedia.org/wikipedia/commons/5/53/Google_%22G%22_Logo.svg" width="20">
            Entrar com Canal do YouTube
        </button>
    </div>

    <div id="app-container">
        <header>
            <div style="font-weight: bold; font-size: 1.2rem;">APEX<span>IA</span> PRO</div>
            <div id="model-tag" style="font-size: 0.6rem; color: #888;">MOTOR: CARREGANDO...</div>
        </header>
        <div id="chat-window">
            <div id="stats-area"></div>
            <div class="msg ai">Conectado! Estou preparando seu relat√≥rio de performance...</div>
        </div>
        <div class="input-box">
            <input type="text" id="user-input" placeholder="Pergunte sobre sua performance...">
            <button onclick="askGemini()">Analisar</button>
        </div>
    </div>

    <script>
        const CLIENT_ID = "145100322345-70nlh619s577puk5c75u19trip13nkme.apps.googleusercontent.com";
        const GEMINI_KEY = "AIzaSyAz-4miGzuQkFtzNi4UWIZABTjolKzDcUQ"; 
        
        let accessToken = localStorage.getItem('apexia_token');
        let tokenClient;
        let modeloEncontrado = "models/gemini-1.5-flash";
        let contextoCanalGlobal = "Dados ainda n√£o carregados.";

        window.onload = function() {
            tokenClient = google.accounts.oauth2.initTokenClient({
                client_id: CLIENT_ID,
                scope: 'https://www.googleapis.com/auth/youtube.readonly https://www.googleapis.com/auth/yt-analytics.readonly',
                callback: (tokenResponse) => { if (tokenResponse.access_token) saveLogin(tokenResponse.access_token); },
            });
            if (accessToken) entrarNoApp();
        };

        function iniciarLogin() { tokenClient.requestAccessToken(); }

        function saveLogin(token) {
            accessToken = token;
            localStorage.setItem('apexia_token', token);
            entrarNoApp();
        }

        async function entrarNoApp() {
            document.getElementById('landing-page').style.display = 'none';
            document.getElementById('app-container').style.display = 'flex';
            await configurarMelhorModelo();
            await puxarDadosEAnalytics();
        }

        async function configurarMelhorModelo() {
            try {
                const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models?key=${GEMINI_KEY}`);
                const data = await res.json();
                const preferido = data.models.find(m => m.name.includes("1.5-flash")) || data.models[0];
                modeloEncontrado = preferido.name;
                document.getElementById('model-tag').innerText = "MOTOR: " + modeloEncontrado.split('/')[1].toUpperCase();
            } catch (e) { console.error("Erro IA"); }
        }

        async function puxarDadosEAnalytics() {
            try {
                // 1. Dados B√°sicos
                const resB = await fetch('https://www.googleapis.com/youtube/v3/channels?part=snippet,statistics&mine=true', {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                const dataB = await resB.json();
                const canal = dataB.items[0];
                const nome = canal.snippet.title;
                const subs = canal.statistics.subscriberCount;

                // 2. Dados de Performance Reais (√öltimos 28 dias)
                const hoje = new Date().toISOString().split('T')[0];
                const trintaDiasAtras = new Date(new Date().setDate(new Date().getDate() - 30)).toISOString().split('T')[0];
                
                const resA = await fetch(`https://youtubeanalytics.googleapis.com/v1/reports?ids=channel==MINE&startDate=${trintaDiasAtras}&endDate=${hoje}&metrics=views,estimatedMinutesWatched,averageViewDuration,averageViewPercentage,subscribersGained&dimensions=day`, {
                    headers: { 'Authorization': `Bearer ${accessToken}` }
                });
                const analytics = await resA.json();
                
                // Processar totais simples para a IA
                let totalViews = 0;
                analytics.rows.forEach(r => totalViews += r[1]);

                contextoCanalGlobal = `
                    O usu√°rio est√° logado no canal: ${nome}.
                    Total de Inscritos: ${subs}.
                    Performance nos √∫ltimos 30 dias:
                    - Total de Visualiza√ß√µes: ${totalViews}
                    - Reten√ß√£o M√©dia (Segundos): ${analytics.rows[0][3] || "N/A"}
                    - Inscritos ganhos no per√≠odo: ${analytics.rows[0][5] || "N/A"}
                `;

                document.getElementById('stats-area').innerHTML = `
                    <div class="data-chip">üìä Canal: <b>${nome}</b> | Inscritos: <b>${Number(subs).toLocaleString()}</b> | Views (30d): <b>${totalViews}</b></div>
                `;
                
                addMsg('ai', `Relat√≥rio carregado! Analisei seu canal **${nome}**. Recebi seus dados de visualiza√ß√µes e reten√ß√£o dos √∫ltimos 30 dias. Como posso ajudar na sua estrat√©gia hoje?`);

            } catch (e) { 
                addMsg('ai', "Conectado! Mas n√£o consegui puxar o Analytics. Verifique se a 'YouTube Analytics API' est√° ativa no Google Cloud.");
            }
        }

        async function askGemini() {
            const input = document.getElementById('user-input');
            const texto = input.value.trim();
            if (!texto) return;

            addMsg('user', texto);
            input.value = '';

            // O SEGREDO: Injetar os dados do canal em cada pergunta
            const promptComDados = `
                CONTEXTO DO CANAL DO USU√ÅRIO:
                ${contextoCanalGlobal}

                INSTRU√á√ÉO PARA VOC√ä (IA):
                Voc√™ √© o Mentor ApexiA. Voc√™ TEM acesso aos dados acima. 
                N√£o diga que n√£o consegue ler os dados. Use os n√∫meros fornecidos para responder.
                Seja direto e foque em Growth.

                PERGUNTA DO USU√ÅRIO:
                ${texto}
            `;

            try {
                const url = `https://generativelanguage.googleapis.com/v1beta/${modeloEncontrado}:generateContent?key=${GEMINI_KEY}`;
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: promptComDados }] }] })
                });

                const data = await response.json();
                addMsg('ai', data.candidates[0].content.parts[0].text);
            } catch (e) {
                addMsg('ai', "Erro na comunica√ß√£o com a IA.");
            }
        }

        function addMsg(role, content) {
            const chat = document.getElementById('chat-window');
            const div = document.createElement('div');
            div.className = `msg ${role}`;
            div.innerText = content;
            chat.appendChild(div);
            chat.scrollTop = chat.scrollHeight;
        }
    </script>
</body>
</html>
