<script>
    const CLIENT_ID = "145100322345-70nlh619s577puk5c75u19trip13nkme.apps.googleusercontent.com";
    const BACKEND_URL = "https://apexia-backend.vercel.app/api/mentor";
    const mentorYouTubePrompt = `Seu prompt completo...`;

    let accessToken = localStorage.getItem('apexia_token');
    let tokenClient;
    let chats = JSON.parse(localStorage.getItem('apexia_history_final')) || {};
    let currentChatId = null;
    let pendingImage = null;
    let canalDataGlobal = "";
    let selectedVideoId = null; // <-- ID do vídeo selecionado

    window.onload = () => {
        tokenClient = google.accounts.oauth2.initTokenClient({
            client_id: CLIENT_ID,
            scope: 'https://www.googleapis.com/auth/youtube.readonly https://www.googleapis.com/auth/yt-analytics.readonly',
            callback: (res) => { if(res.access_token) handleAuth(res.access_token); }
        });
        if (accessToken) handleAuth(accessToken, true);
    };

    function iniciarLogin() { if(tokenClient) tokenClient.requestAccessToken({ prompt: 'consent' }); }
    function logout() { localStorage.clear(); location.reload(); }

    async function handleAuth(token, auto = false) {
        accessToken = token; 
        localStorage.setItem('apexia_token', token);
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('selection-menu').style.display = 'flex';
        if(!auto) { confetti({ particleCount: 150, colors: ['#00FF00', '#FFFFFF'] }); }
        await carregarCanal();
    }

    async function carregarCanal() {
        try {
            const res = await fetch('https://www.googleapis.com/youtube/v3/channels?part=snippet,statistics&mine=true', { 
                headers: { 'Authorization': `Bearer ${accessToken}` } 
            });
            const data = await res.json();
            const c = data.items[0];
            document.getElementById('d-subs').innerText = Number(c.statistics.subscriberCount).toLocaleString();
            document.getElementById('d-views').innerText = Number(c.statistics.viewCount).toLocaleString();
            document.getElementById('d-vids').innerText = c.statistics.videoCount;
            document.getElementById('chan-label').innerText = c.snippet.title.toUpperCase();
            canalDataGlobal = `CANAL: ${c.snippet.title}, SUBS: ${c.statistics.subscriberCount}, VIEWS: ${c.statistics.viewCount}.`;
        } catch(e){ console.error("Erro API"); }
    }

    async function abrirVideoSelection() {
        try {
            const res = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&channelId=MINE&maxResults=50&order=date`, {
                headers: { 'Authorization': `Bearer ${accessToken}` }
            });
            const data = await res.json();
            const list = document.getElementById('video-list');
            list.innerHTML = '';
            data.items.forEach(v => {
                if(!v.id.videoId) return;
                const div = document.createElement('div');
                div.className = 'video-item';
                div.textContent = v.snippet.title;
                div.onclick = () => { 
                    selectedVideoId = v.id.videoId; // <-- salva o vídeo selecionado
                    document.getElementById('video-selection').style.display='none'; 
                    irParaMentoria(); 
                    canalDataGlobal += ` VIDEO_ID: ${selectedVideoId}`; 
                };
                list.appendChild(div);
            });
            document.getElementById('selection-menu').style.display = 'none';
            document.getElementById('video-selection').style.display = 'flex';
        } catch(e){ alert("Erro ao carregar vídeos."); console.error(e); }
    }

    function irParaMentoria() { 
        document.getElementById('selection-menu').style.display='none'; 
        document.getElementById('app-container').style.display='flex'; 
        renderHistory(); 
        if(!currentChatId) novoChat(); else selectChat(currentChatId); 
    }

    async function enviar() {
        const input = document.getElementById('user-input');
        const text = input.value.trim();
        if(!text && !pendingImage) return;

        chats[currentChatId].messages.push({ role: 'user', content: text, img: pendingImage });
        if(chats[currentChatId].title === "Comando Novo") chats[currentChatId].title = text.substring(0, 18);
        
        renderChat();
        input.value = '';
        const imgToSend = pendingImage;
        pendingImage = null;

        const win = document.getElementById('chat-window');
        const loader = document.createElement('div');
        loader.className = "thinking";
        loader.innerHTML = `<img src="logo.png" onerror="this.src='https://via.placeholder.com/35/00FF00/000000?text=A'"> Analisando...`;
        win.appendChild(loader); win.scrollTop = win.scrollHeight;

        const historyContext = chats[currentChatId].messages.slice(-10).map(m => `${m.role === 'user' ? 'Usuário' : 'Mentor'}: ${m.content}`).join('\n');

        try {
            const promptWithVideo = `${mentorYouTubePrompt}\n\n${canalDataGlobal}${selectedVideoId ? `\nVIDEO_ID: ${selectedVideoId}` : ''}\n\nHISTÓRICO:\n${historyContext}\n\nPERGUNTA: ${text}`;
            const response = await fetch(BACKEND_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ prompt: promptWithVideo, image: imgToSend })
            });
            const data = await response.json();
            loader.remove();
            chats[currentChatId].messages.push({ role: 'ai', content: data.reply });
            save(); renderChat(); renderHistory();
        } catch (e) { loader.innerText = "ERRO. LIGUE A VPN."; }
    }

    // ... resto do código existente (renderChat, renderHistory, handleImage, etc.) permanece igual
</script>
