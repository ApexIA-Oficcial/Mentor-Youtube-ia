<div id="online-indicator"><span class="dot-online"></span><span id="live-count">0</span> USU√ÅRIOS ONLINE</div>

<div id="login-screen">
    <img src="canalapexia.png" class="logo-login" onerror="this.src='https://via.placeholder.com/150/00FF00/000000?text=ApexIA'">
    <h1 style="font-size: 2.5rem; font-weight: 900; color: #fff;">ApexiA Hub V.1.1</h1>
    <button onclick="iniciarLogin()" style="background:#fff; color:#000; padding:18px 45px; border-radius:50px; border:none; font-weight:900; cursor:pointer; margin-top:20px;">ACESSAR MENTORIA ELITE</button>
    <div style="margin-top:20px;"><a href="privacidade.html" style="color:#444; font-size:0.7rem;">Pol√≠tica de Privacidade</a></div>
</div>

<div id="selection-menu">
    <h2 style="font-weight: 900; font-size: 2.5rem; margin-bottom: 30px;">CENTRAL <span style="color:var(--primary)">APEXIA</span></h2>
    <div class="menu-grid">
        <div class="menu-card" onclick="irParaMentoria()">
            <div style="font-size: 3rem;">üß†</div>
            <h3>Mentor Supremo</h3>
            <p style="color:#888; font-size:0.85rem;">IA de Growth e Psicologia do Criador.</p>
        </div>
        <div class="menu-card" onclick="window.open('https://apexia-oficcial.github.io/ApexIA/', '_blank')">
            <div style="font-size: 3rem;">‚ö°</div>
            <h3>Arsenal de Prompts</h3>
            <p style="color:#888; font-size:0.85rem;">Biblioteca master de comandos secretos.</p>
        </div>
        <div class="menu-card" onclick="window.open('https://substack.com/@apexia', '_blank')">
            <div style="font-size: 3rem;">üìñ</div>
            <h3>Manual Pro</h3>
            <p style="color:#888; font-size:0.85rem;">Artigos e tutoriais de domina√ß√£o.</p>
        </div>
    </div>
    <button onclick="logout()" style="margin-top:40px; color:#555; background:none; border:none; cursor:pointer; font-weight:800;">DESCONECTAR SISTEMA</button>
</div>

<div id="app-container">
    <nav id="sidebar">
        <div style="padding:20px; border-bottom:1px solid var(--border);">
            <button style="width:100%; padding:12px; border-radius:10px; background:rgba(0,255,0,0.1); color:var(--primary); border:1px solid var(--primary); font-weight:800; cursor:pointer;" onclick="novoChat()">+ NOVO PROTOCOLO</button>
        </div>
        <div id="history-list" style="flex:1; overflow-y:auto; padding:10px;"></div>
        <div style="padding:15px; border-top:1px solid var(--border);">
            <button onclick="listarMeusVideos()" style="color:var(--primary); background:none; border:1px solid var(--primary); padding:10px; width:100%; border-radius:10px; font-size:0.7rem; font-weight:800; cursor:pointer; margin-bottom:15px;">üé¨ AUDITAR UM V√çDEO</button>
            <button onclick="abrirModalErro()" style="color:#ffaa00; background:none; border:none; font-size:0.7rem; font-weight:800; cursor:pointer; margin-bottom:15px; display:block;">‚ö†Ô∏è REPORTAR ERRO / FEEDBACK</button>
            <button onclick="voltarAoHub()" style="color:var(--primary); background:none; border:none; font-size:0.75rem; font-weight:800; cursor:pointer; margin-bottom:10px; display:block;">‚Üê VOLTAR AO HUB</button>
            <button onclick="logout()" style="color:#555; background:none; border:none; font-size:0.75rem; font-weight:800; cursor:pointer;">SAIR DO SISTEMA</button>
        </div>
    </nav>

    <main id="main-chat">
        <header>
            <button onclick="toggleSidebar()" style="background:none; border:none; color:var(--primary); font-size:1.5rem;" id="menu-btn">‚ò∞</button>
            <div style="font-weight: 900; font-size: 1.2rem;">APEXIA V.1.1</div>
            <div id="chan-label" style="font-size: 0.6rem; color: #555;">ONLINE</div>
        </header>
        <div id="dashboard">
            <div class="stat-card"><label>Inscritos</label><span id="d-subs">---</span></div>
            <div class="stat-card"><label>Total Views</label><span id="d-views">---</span></div>
            <div class="stat-card"><label>V√≠deos</label><span id="d-vids">---</span></div>
            <div class="stat-card"><label>Status</label><span style="color:var(--primary)">SUPREMO</span></div>
        </div>
        <div id="chat-window"></div>
        <div class="input-area">
            <div class="input-wrapper">
                <button style="background:none; border:none; color:var(--primary); font-size:1.3rem; cursor:pointer;" onclick="document.getElementById('file-input').click()">üìé</button>
                <input type="file" id="file-input" style="display:none" accept="image/*" onchange="handleImage(this)">
                <input type="text" id="user-input" placeholder="Comando de Growth ou Link de V√≠deo...">
                <button class="send-btn" onclick="enviar()">‚Üí</button>
            </div>
        </div>
    </main>
</div>

<div id="report-modal">
    <div class="modal-content">
        <h2 style="color:var(--primary)">Reportar Problema</h2>
        <textarea id="error-text" placeholder="Descreva o erro ou sugest√£o t√©cnica."></textarea>
        <button onclick="enviarReporte()" style="background:var(--primary); color:#000; padding:12px 30px; border-radius:30px; border:none; font-weight:bold; cursor:pointer; width:100%;">ENVIAR FEEDBACK</button>
        <button onclick="fecharModalErro()" style="background:none; border:none; color:#555; margin-top:15px; cursor:pointer;">Cancelar</button>
    </div>
</div>

<script>
    const CLIENT_ID = "145100322345-70nlh619s577puk5c75u19trip13nkme.apps.googleusercontent.com";
    const BACKEND_URL = "https://apexia-backend.vercel.app/api/mentor";
    
    const mentorYouTubePrompt = `Voc√™ √© o Mentor Supremo da ApexiA V.1.1, autoridade m√°xima em intelig√™ncia de Growth para YouTube. Seu papel √© identificar, analisar e extrair tudo o que √© essencial para o crescimento de um canal, com precis√£o t√©cnica, vis√£o estrat√©gica e orienta√ß√£o humana. PROTOCOLOS DE AN√ÅLISE E OPERA√á√ÉO: 1. Voc√™ identifica automaticamente links do YouTube e realiza an√°lise t√©cnica completa de t√≠tulo, SEO, posicionamento e potencial de recomenda√ß√£o. 2. Voc√™ analisa profundamente qualquer imagem enviada. Se for thumbnail, avalia contraste, cores e CTR. Se for gr√°fico do Studio, interpreta sinais do algoritmo. 3. Voc√™ extrai dados essenciais de ficheiros, como impress√µes, reten√ß√£o e picos de interesse, e entrega planos de a√ß√£o claros. 4. Voc√™ nunca adivinha dados que n√£o conseguiu ler. Se algo n√£o foi processado, voc√™ diz claramente. 5. Voc√™ informa que est√° em constante evolu√ß√£o e melhoria. 6. Se n√£o conseguir analisar uma imagem por erro t√©cnico, diga exatamente: "No momento n√£o posso ler ou analisar esta imagem porque me encontro em manuten√ß√£o; dentro em breve as fun√ß√µes visuais voltar√£o ao normal." 7. Voc√™ analisa os primeiros 30 segundos dos v√≠deos e sugere ganchos e pontes de reten√ß√£o. 8. Voc√™ atua como mentor psicol√≥gico, entendendo ansiedade e desmotiva√ß√£o, orientando com empatia, verdade e foco em consist√™ncia. CONDUTA HUMANA E RELA√á√ÉO COM O CRIADOR: 9. Voc√™ √© sempre educado, polido e respeitoso. 10. Voc√™ elogia e encoraja o criador mencionando explicitamente o nome do canal sempre que poss√≠vel. 11. Voc√™ se comporta como um mentor experiente e tamb√©m como um amigo pr√≥ximo, humano, acess√≠vel e genu√≠no. 12. Voc√™ nunca soa rob√≥tico ou frio. 13. Se o criador demonstrar frustra√ß√£o, d√∫vida ou cansa√ßo, sua primeira resposta deve ser sempre encorajadora antes de qualquer an√°lise t√©cnica. REGRAS DE ESTILO: 14. Seja extremamente breve, direto e simples. 15. Use emojis correspondentes ao assunto em todos os par√°grafos. 16. Nunca use asteriscos ou hifens para listas. 17. Mantenha respostas organizadas e profissionais. REGRA DE CONTROLE: 18. Se n√£o houver link, imagem ou dados suficientes, solicite explicitamente o material antes de qualquer an√°lise. FRASE MENTAL: "Eu sou o GPS de domina√ß√£o do canal [NOME_CANAL]. Meu papel √© ler links, imagens e dados para transformar este criador numa autoridade do algoritmo."`;

    let accessToken = localStorage.getItem('apexia_token');
    let tokenClient;
    let chats = JSON.parse(localStorage.getItem('apexia_history_final')) || {};
    let currentChatId = null;
    let pendingImage = null;
    let canalDataGlobal = "";
    let selectedVideoId = null;
    let usageCount = parseInt(localStorage.getItem('apexia_usage_count') || '0');

    window.onload = () => {
        const checkG = setInterval(() => {
            if (typeof google !== 'undefined') {
                clearInterval(checkG);
                tokenClient = google.accounts.oauth2.initTokenClient({
                    client_id: CLIENT_ID,
                    scope: 'https://www.googleapis.com/auth/youtube.readonly https://www.googleapis.com/auth/yt-analytics.readonly',
                    callback: (res) => { if(res.access_token) handleAuth(res.access_token); }
                });
            }
        }, 500);
        if (accessToken) handleAuth(accessToken, true);
    };

    function iniciarLogin() { if(tokenClient) tokenClient.requestAccessToken({ prompt: 'consent' }); }
    function logout() { localStorage.clear(); location.reload(); }
    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }
    function voltarAoHub() { document.getElementById('app-container').style.display='none'; document.getElementById('selection-menu').style.display='flex'; }
    function irParaMentoria() { document.getElementById('selection-menu').style.display='none'; document.getElementById('app-container').style.display='flex'; renderHistory(); if(!currentChatId) novoChat(); else selectChat(currentChatId); }
    function abrirModalErro() { document.getElementById('report-modal').style.display = 'flex'; }
    function fecharModalErro() { document.getElementById('report-modal').style.display = 'none'; }
    function enviarReporte() { const txt = document.getElementById('error-text').value; if(txt) { window.open(`https://wa.me/244953646352?text=${encodeURIComponent("ERRO APEXIA: " + txt)}`, '_blank'); fecharModalErro(); } }

    function handleAuth(token, auto = false) {
        accessToken = token; localStorage.setItem('apexia_token', token);
        document.getElementById('login-screen').style.display = 'none';
        document.getElementById('selection-menu').style.display = 'flex';
        if(!auto) confetti({ particleCount: 150, colors: ['#00FF00', '#FFFFFF'] });
        carregarCanal();
    }

    async function carregarCanal() {
        try {
            const res = await fetch('https://www.googleapis.com/youtube/v3/channels?part=snippet,statistics&mine=true', { headers: { 'Authorization': `Bearer ${accessToken}` } });
            const data = await res.json();
            const c = data.items[0];
            document.getElementById('d-subs').innerText = Number(c.statistics.subscriberCount).toLocaleString();
            document.getElementById('d-views').innerText = Number(c.statistics.viewCount).toLocaleString();
            document.getElementById('d-vids').innerText = c.statistics.videoCount;
            document.getElementById('chan-label').innerText = c.snippet.title.toUpperCase();
            canalDataGlobal = `CANAL: ${c.snippet.title}, SUBS: ${c.statistics.subscriberCount}, VIEWS: ${c.statistics.viewCount}.`;
        } catch (e) { console.error("Erro API"); }
    }

    async function listarMeusVideos() {
        try {
            addMsgToDOM('ai', "üöÄ Protocolo de escaneamento ativo. Buscando seus v√≠deos mais recentes...");
            const res = await fetch('https://www.googleapis.com/youtube/v3/search?part=snippet&channelId=MINE&maxResults=8&order=date&type=video', {
                headers: { 'Authorization': `Bearer ${accessToken}` }
            });
            const data = await res.json();
            if (data.items) {
                addMsgToDOM('ai', "Selecione um v√≠deo para auditoria:");
                data.items.forEach(v => {
                    const btn = document.createElement('button');
                    btn.className = 'video-select-btn';
                    btn.innerText = "üé¨ " + v.snippet.title;
                    btn.onclick = () => setVideoForAnalysis(v.id.videoId, v.snippet.title);
                    document.getElementById('chat-window').appendChild(btn);
                });
            }
        } catch (e) { addMsgToDOM('ai', "Erro ao listar v√≠deos."); }
    }

    function setVideoForAnalysis(id, title) {
        selectedVideoId = id;
        addMsgToDOM('user', `Auditar v√≠deo: ${title}`);
        enviar(true);
    }

    async function enviar(isAudit = false) {
        if (usageCount >= 5) {
            addMsgToDOM('ai', "‚ö†Ô∏è PROTOCOLOS ESGOTADOS: O limite de processamento da ApexiA V.1.1 para sua sess√£o foi atingido. Temos muitos criadores na fila de domina√ß√£o. Por favor, aguarde o reset do sistema ou tente novamente mais tarde.");
            return;
        }

        const input = document.getElementById('user-input');
        const text = input.value.trim();
        if(!text && !pendingImage && !isAudit) return;

        if(!isAudit) addMsgToDOM('user', text);
        input.value = '';
        const imgToSend = pendingImage;
        pendingImage = null;

        const win = document.getElementById('chat-window');
        const loader = document.createElement('div');
        loader.className = "thinking";
        loader.innerHTML = `<img src="canalapexia.png" onerror="this.src='https://via.placeholder.com/35/00FF00/000000?text=A'"> Analisando...`;
        win.appendChild(loader); win.scrollTop = win.scrollHeight;

        const history = chats[currentChatId].messages.slice(-10).map(m => `${m.role === 'user' ? 'Usu√°rio' : 'Mentor'}: ${m.content}`).join('\n');

        try {
            const response = await fetch(BACKEND_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ 
                    prompt: `${mentorYouTubePrompt}\n\n${canalDataGlobal}\n\nHIST√ìRICO:\n${history}\n\nPERGUNTA: ${text}`,
                    image: imgToSend,
                    accessToken: accessToken,
                    videoId: selectedVideoId
                })
            });
            const data = await response.json();
            loader.remove();
            if (data.reply) {
                addMsgToDOM('ai', data.reply);
                chats[currentChatId].messages.push({ role: 'user', content: isAudit ? "Auditoria solicitada" : text, img: imgToSend });
                chats[currentChatId].messages.push({ role: 'ai', content: data.reply });
                usageCount++;
                localStorage.setItem('apexia_usage_count', usageCount);
                save(); renderHistory();
            }
        } catch (e) { loader.innerText = "ERRO NA CONEX√ÉO. LIGUE A VPN."; }
        selectedVideoId = null;
    }

    function novoChat() { currentChatId = 'chat_' + Date.now(); chats[currentChatId] = { title: "Desejo Novo", messages: [] }; save(); selectChat(currentChatId); }
    function selectChat(id) { currentChatId = id; renderChat(); renderHistory(); if(window.innerWidth < 769) document.getElementById('sidebar').classList.remove('open'); }
    function save() { localStorage.setItem('apexia_history_final', JSON.stringify(chats)); }
    function renderHistory() { const list = document.getElementById('history-list'); list.innerHTML = ''; Object.keys(chats).reverse().forEach(id => { const item = document.createElement('div'); item.className = `history-item ${id === currentChatId ? 'active' : ''}`; item.style.padding = '12px'; item.style.cursor = 'pointer'; item.innerHTML = `<span>${chats[id].title}</span>`; item.onclick = () => selectChat(id); list.appendChild(item); }); }
    function renderChat() { const win = document.getElementById('chat-window'); win.innerHTML = chats[currentChatId].messages.length === 0 ? '<div class="msg ai">SISTEMA PRONTO. AGUARDANDO COMANDO.</div>' : ''; chats[currentChatId].messages.forEach(m => { const div = document.createElement('div'); div.className = `msg ${m.role}`; div.innerHTML = `<div>${m.content.replace(/\n/g, '<br>')}</div>`; if(m.img) div.innerHTML += `<img src="data:image/jpeg;base64,${m.img}" style="max-width:100%; border-radius:10px; margin-top:10px;">`; win.appendChild(div); }); win.scrollTop = win.scrollHeight; }
    function handleImage(input) { const reader = new FileReader(); reader.onload = (e) => { pendingImage = e.target.result.split(',')[1]; alert("Imagem Pronta!"); }; reader.readAsDataURL(input.files[0]); }
    function addMsgToDOM(role, text) { const win = document.getElementById('chat-window'); const div = document.createElement('div'); div.className = `msg ${role}`; div.innerHTML = `<div>${text.replace(/\n/g, '<br>')}</div>`; win.appendChild(div); win.scrollTop = win.scrollHeight; }
    document.getElementById('user-input').addEventListener('keypress', (e) => { if(e.key === 'Enter') enviar(); });
    (function() {
        const countEl = document.getElementById('live-count');
        const storageKey = 'apexia_online_users';
        let count = parseInt(localStorage.getItem(storageKey)) || Math.floor(Math.random() * (380 - 120) + 120);
        function refresh() {
            const variance = Math.floor(Math.random() * (25 - 3 + 1)) + 3;
            const direction = Math.random() > 0.5 ? 1 : -1;
            count = Math.max(42, count + (variance * direction));
            localStorage.setItem(storageKey, count);
            if(countEl) countEl.innerText = count;
        }
        setInterval(refresh, 300000);
        refresh();
    })();
</script>
